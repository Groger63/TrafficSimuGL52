/** 
 * 
 */
package ^agent

import environnement.Car
import utils.Converter

/** 
 * @author Nicolas
 * 
 * Comportement que le conducteur adoptera lorsqu'une voiture se situera dans son champs de vision
 */
class BehaviorFollowing {
	def run(body : Car, distanceFromObject : float, maxSpeed : float, speedObject : float) : float
	{
		return computeIDM(body.maxAcc, body.minAcc, distanceFromObject, body.speed, maxSpeed, speedObject)
	
	}
	
	def computeIDM(
		maxAccAgent : float, //the maximal acceleration
		maxDesAgent : float, //the comfortable braking deceleration
		distanceFromObject : float, //the distance to the ahead object
		currSpeed : float,
		idealSpeed : float,
		speedObject : float
	) : float
	{
		var finalAcc : float;
		//System.out.println("Distance from obj : " + distanceFromObject)
		//System.out.println("Current speed ms : " + currSpeed)
		//System.out.println("Current speed km : " + Converter.convertMStoKM(currSpeed))
		var safetyDistance = (Converter.convertMStoKM(currSpeed) / 10) * 6
		//System.out.println("Safety Distance : " + safetyDistance)
		if (safetyDistance < 10)
			safetyDistance = 10
		//System.out.println("Safety Distance : " + safetyDistance)
		var diffSpeed = currSpeed - speedObject
		//System.out.println("Diff Vitesse : " + diffSpeed)
		var timeBeforeCollision = distanceFromObject / idealSpeed
		//System.out.println("timeBeforeCollision : " + timeBeforeCollision)
		
		var firstPart = Math.pow(currSpeed/idealSpeed, 4)
		//System.out.println("firstPart : " + firstPart)
		
		var secondPart1 = (safetyDistance + currSpeed * timeBeforeCollision) / distanceFromObject
		var secondPart2 = (currSpeed * diffSpeed) / (2 * distanceFromObject * Math.sqrt(maxAccAgent * maxDesAgent))
		//System.out.println("secondPartFirst : " + secondPart1)
		//System.out.println("secondPartSecond : " + secondPart2)
		
		var secondPart = Math.pow(secondPart1 + secondPart2, 2)
		//System.out.println("secondPart : " + secondPart)

		var precal = (1 - firstPart - secondPart)
		if (precal > 0)
			finalAcc = (maxAccAgent * precal).floatValue
		else
			finalAcc = (maxDesAgent * precal).floatValue
		//System.out.println("finalSpep : " + finalAcc
		if (finalAcc < -maxDesAgent)
			finalAcc = -maxDesAgent
		if (finalAcc > maxAccAgent)
			finalAcc = maxAccAgent
		return finalAcc.floatValue
	}
	
}
